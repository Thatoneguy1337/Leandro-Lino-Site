<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa Lino</title>

  <link rel="manifest" href="manifest.webmanifest?v=1">
  <link rel="icon" id="favicon" href="assets/icons/icon-192.png" type="image/png">

  <!-- iOS / iPadOS -->
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GeoViewer">

  <!-- Android/Chrome -->
  <meta name="theme-color" content="#0d6efd">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link rel="stylesheet" href="assets/styles.css?v=3">
  <link id="favicon" rel="icon" type="image/png" href="assets/img/image.png" />

  <style>
    .city-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      background: var(--panel-2);
      transition: all 0.2s ease;
    }

    .city-item:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .city-info {
      min-width: 0;
      flex: 1;
    }

    .city-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .system-indicator {
      margin-left: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
      border: 1px solid;
    }

    .mode-online {
      color: #28a745;
      background: #d4edda;
      border-color: #28a745;
    }

    .mode-mixed {
      color: #ffc107;
      background: #fff3cd;
      border-color: #ffc107;
    }

    .mode-offline {
      color: #dc3545;
      background: #f8d7da;
      border-color: #dc3545;
    }

    /* Estilos para loading customizado */
    .system-loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .home-message-panel {
      background: var(--panel-1);
      padding: 12px 16px;
      margin: 0 16px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      position: relative;
    }

    .home-message-panel h3 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .home-message-panel p {
      margin: 0;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .home-message-panel .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text-muted);
    }
  </style>
</head>

<body>

  <!-- ========== SIDEBAR ========== -->
  <aside id="kmzSidebar" class="sidebar" aria-label="Menu lateral">
    <div class="sidebar-header">
      <div class="brand">
        <img id="brandLogo" src="assets/img/image.png" alt="Logo" />
        <div>
          <h1 class="app-title">Mapa Lino</h1>
          <p class="app-subtitle" id="systemSubtitle">Carregando...</p>
        </div>
      </div>
      <button class="ghost-btn" id="closeSidebar" title="Fechar painel" aria-label="Fechar painel">‚úï</button>
    </div>

    <!-- Mensagem da Home -->
    <div id="homeMessagePanel" class="home-message-panel" style="display:none;">
      <h3>Aviso</h3>
      <p id="homeMessageContent"></p>
      <button id="closeHomeMessage" class="close-btn" title="Fechar aviso">‚úï</button>
    </div>

    <nav class="sidebar-sections" aria-label="Se√ß√µes">
      <!-- ========== CIDADES ========== -->
      <section class="panel-section" aria-labelledby="sec-cities">
        <h2 id="sec-cities">üåÜ Cidades</h2>

        <div class="row gap">
          <div class="search small" style="flex:1">
            <input id="cityPickerSearch" type="search" placeholder="Buscar cidade/bairro‚Ä¶"
              aria-label="Buscar cidade ou bairro" />
          </div>
        </div>

        <div id="cityPickerList" class="list-card" role="list" aria-label="Cidades dispon√≠veis"
          style="margin-top:8px; max-height: 280px; overflow:auto;">
          <div class="empty">
            <div class="empty-ico">‚è≥</div>
            <p>Inicializando sistema...</p>
          </div>
        </div>

        <div class="file-meta" style="margin-top:10px">
          <div class="meta-row">
            <span class="meta-label">Status:</span>
            <span id="currentFile" class="meta-value">Sistema iniciando...</span>
          </div>
        </div>
      </section>

      <!-- ========== CAMADAS / ALIMENTADORES ========== -->
      <section class="panel-section" aria-labelledby="sec-layers">
        <h2 id="sec-layers">üóÇÔ∏è Camadas / Alimentadores</h2>

        <div class="row gap">
          <button id="hideAllLayers" class="btn">Ocultar todas</button>
          <button id="showAllLayers" class="btn">Exibir todas</button>
        </div>

        <div id="layersList" class="layers-list" role="group" aria-label="Lista de camadas / alimentadores">
          <div class="empty">
            <div class="empty-ico">üóÇÔ∏è</div>
            <p>Nenhuma camada carregada</p>
          </div>
        </div>
      </section>

      <!-- ========== GRUPOS DE POSTOS ========== -->
      <section class="panel-section" aria-labelledby="sec-posts">
        <h2 id="sec-posts">üìå Grupos de Postos</h2>

        <div class="row gap">
          <button id="hideAllPosts" class="btn">Ocultar todas</button>
          <button id="showAllPosts" class="btn">Exibir todas</button>
        </div>

        <div id="postsLayersList" class="layers-list" role="group" aria-label="Lista de grupos de postos">
          <div class="empty">
            <div class="empty-ico">üìç</div>
            <p>Nenhum posto carregado</p>
          </div>
        </div>
      </section>

      <!-- ========== ESTAT√çSTICAS ========== -->
      <section class="panel-section" aria-labelledby="sec-stats">
        <h2 id="sec-stats">üìä Estat√≠sticas</h2>
        <ul class="stats-grid" role="list">
          <li class="stat">
            <div class="stat-ico">üìç</div>
            <div class="stat-val" id="markerCount">0</div>
            <div class="stat-lbl">Marcadores</div>
          </li>
          <li class="stat">
            <div class="stat-ico">üìè</div>
            <div class="stat-val" id="lineCount">0</div>
            <div class="stat-lbl">Linhas</div>
          </li>
          <li class="stat">
            <div class="stat-ico">‚¨°</div>
            <div class="stat-val" id="polygonCount">0</div>
            <div class="stat-lbl">Pol√≠gonos</div>
          </li>
        </ul>
      </section>
    </nav>
  </aside>

  <!-- ========== TOPO ========== -->
  <header id="topbar" class="topbar" role="banner">
    <div class="top-left">
      <button id="openSidebar" class="icon-btn" aria-label="Abrir painel">‚ò∞</button>

      <a class="top-brand" href="#" aria-label="Mapa Lino">
        <img id="brandLogoTop" src="assets/img/image.png" alt="Logo Mapa Lino" />
      </a>
    </div>

    <div class="top-center" role="search">
      <form id="searchForm" class="search" autocomplete="off">
        <input id="searchInput" type="tel" inputmode="numeric" pattern="\d*"
          placeholder="Buscar CHAVE (s√≥ n√∫meros, ex.: 27)" aria-label="Buscar chave por n√∫mero" enterkeyhint="search" />
        <button id="searchBtn" type="submit" class="icon-btn" aria-label="Buscar">üîé</button>
      </form>
      <div id="searchResults" class="search-results" role="listbox" aria-label="Resultados de busca"></div>
    </div>

    <div class="top-right" aria-label="Acessibilidade" role="group">
      <button id="themeToggle" class="icon-btn" title="Modo escuro" aria-pressed="false"
        aria-label="Alternar tema">üåô</button>
    </div>
  </header>

  <!-- ========== CONTE√öDO / MAPA ========== -->
  <main id="content" class="content" role="main">
    <div id="map" class="map" aria-label="Mapa"></div>

    <!-- Controles flutuantes -->
    <div class="map-fab-group" aria-label="Controles do mapa" role="group">
      <button id="toggleSatellite" class="fab" title="Vista sat√©lite">üõ∞Ô∏è</button>
      <button id="toggleTerrain" class="fab" title="Vista terreno">üèîÔ∏è</button>
      <button id="zoomIn" class="fab" title="Aproximar">Ôºã</button>
      <button id="zoomOut" class="fab" title="Afastar">Ôºç</button>
      <button id="locateMe" class="fab" title="Minha localiza√ß√£o">üìç</button>
    </div>
  </main>

  <!-- ========== STATUS BAR ========== -->
  <footer id="statusBar" class="statusbar" role="contentinfo" aria-live="polite">
    <div class="status-left">
      <span class="status-dot" aria-hidden="true"></span>
      <span id="statusText">Inicializando sistema...</span>
      <span id="systemIndicator" class="system-indicator mode-offline">OFFLINE</span>
    </div>

    <div class="developer-credit">
      <small>
        <strong>Desenvolvido por</strong>
        Leandro Lino ¬© 2025
      </small>
    </div>

    <div id="filesUpdatedAt" class="status-updates"
      style="text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
      Sistema h√≠brido - Conectando...
    </div>

    <div id="coordinates" class="status-right" aria-label="Coordenadas do cursor">
      Lat: 0.000000, Lon: 0.000000
    </div>
  </footer>

  <!-- ========== LOADING ========== -->
  <div id="loadingOverlay" class="loading" aria-hidden="true" aria-live="polite">
    <div class="loading-box" role="alert">
      <img id="loadingLogo" class="loading-logo" alt="" />
      <p id="loadingText">Processando arquivo‚Ä¶</p>
    </div>
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <!-- Script principal carregado de forma ass√≠ncrona -->
  <script src="assets/script.js"></script>

  <script>
    /* ========= SISTEMA H√çBRIDO INDEPENDENTE ========= */
    const SYSTEM_MODE = {
      OFFLINE: 'offline',
      ONLINE: 'online',
      MIXED: 'mixed'
    };

    let currentMode = SYSTEM_MODE.OFFLINE;
    let systemInitialized = false;

    /* ========= DADOS DE FALLBACK ========= */
    const FALLBACK_CITIES = [
      {
        id: 'demo-1',
        name: 'S√£o Paulo - Demo',
        prefix: 'SP',
        isDefault: true,
        file: { name: 'sao_paulo_demo.kmz', url: 'assets/examples/sao_paulo.kmz' },
        updatedAt: Math.floor(Date.now() / 1000),
        defaultAt: Math.floor(Date.now() / 1000),
        description: 'Cidade demonstrativa para testes'
      },
      {
        id: 'demo-2',
        name: 'Rio de Janeiro - Demo',
        prefix: 'RJ',
        isDefault: false,
        file: { name: 'rio_demo.kmz', url: 'assets/examples/rio.kmz' },
        updatedAt: Math.floor(Date.now() / 1000),
        description: 'Exemplo de configura√ß√£o'
      },
      {
        id: 'demo-3',
        name: 'Belo Horizonte - Demo',
        prefix: 'BHZ',
        isDefault: false,
        file: { name: 'bh_demo.kmz', url: 'assets/examples/bh.kmz' },
        updatedAt: Math.floor(Date.now() / 1000),
        description: 'Modelo demonstrativo'
      }
    ];

    // ========= FUN√á√ïES INDEPENDENTES DA API =========
    async function apiListCities() {
      try {
        console.log('üåê Buscando cidades da API...');
        const response = await fetch('api/cities.php?action=list', {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.ok && Array.isArray(data.data)) {
          console.log(`‚úÖ API retornou ${data.data.length} cidades`);
          return data.data;
        } else {
          throw new Error('Resposta da API inv√°lida');
        }
      } catch (error) {
        console.error('‚ùå Erro ao listar cidades:', error);
        throw error;
      }
    }

    async function apiGetCity(id) {
      try {
        const response = await fetch(`api/cities.php?action=get&id=${encodeURIComponent(id)}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        if (data.ok && data.data) {
          return data.data;
        } else {
          throw new Error('Cidade n√£o encontrada');
        }
      } catch (error) {
        console.error('Erro ao obter cidade:', error);
        throw error;
      }
    }

    async function loadCityOnMap(id) {
      try {
        console.log('üîç Carregando cidade ID:', id);

        const city = await apiGetCity(id);
        console.log('üìã Dados da cidade:', city);

        if (!city || !city.file || !city.file.url) {
          console.error('‚ùå Cidade sem arquivo:', city);
          alert('Esta cidade n√£o possui arquivo cadastrado.');
          return;
        }

        const url = city.file.url;
        const name = city.name || 'Modelo';
        const isKmz = /\.kmz$/i.test(url);

        console.log('üì¶ URL do arquivo:', url);
        console.log('üî† Nome:', name);
        console.log('üìÅ √â KMZ?', isKmz);

        // Atualiza status
        updateStatus(`Baixando ${name}‚Ä¶`);
        showLocalLoading(true, `Carregando ${name}‚Ä¶`);

        // Baixa o arquivo
        const response = await fetch(url, { cache: 'no-cache' });
        if (!response.ok) {
          throw new Error(`Falha ao baixar arquivo: ${response.status} ${response.statusText}`);
        }

        // Processa o arquivo
        if (isKmz) {
          console.log('üì¶ Processando KMZ...');
          const blob = await response.blob();
          console.log('üìä Tamanho do blob:', blob.size);

          const fileName = city.file.name || `${city.prefix || 'CITY'}.kmz`;
          const file = new File([blob], fileName, {
            type: blob.type || 'application/vnd.google-earth.kmz'
          });

          // Tenta usar loadKMZ do script.js, fallback para alert
          if (typeof window.loadKMZ === 'function') {
            await window.loadKMZ(file);
          } else {
            throw new Error('Fun√ß√£o loadKMZ n√£o dispon√≠vel. Arquivo KMZ baixado, mas n√£o pode ser processado.');
          }
        } else {
          console.log('üìÑ Processando KML...');
          const text = await response.text();
          console.log('üìù Tamanho do texto:', text.length);

          // Tenta usar parseKML do script.js, fallback para alert
          if (typeof window.parseKML === 'function') {
            await window.parseKML(text, name);
          } else {
            throw new Error('Fun√ß√£o parseKML n√£o dispon√≠vel. Arquivo KML baixado, mas n√£o pode ser processado.');
          }
        }

        // Atualiza interface
        const currentFileEl = document.getElementById('currentFile');
        if (currentFileEl) {
          currentFileEl.textContent = (city.file.name || 'arquivo') + ` (de ${name})`;
        }

        updateStatus(`üì• ${name} carregada`);
        console.log('‚úÖ Cidade carregada com sucesso');

      } catch (error) {
        console.error('‚ùå Erro ao carregar cidade:', error);

        let errorMessage = `Erro ao carregar cidade: ${error.message}`;

        // Mensagens mais amig√°veis para erros comuns
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
        } else if (error.message.includes('404')) {
          errorMessage = 'Arquivo n√£o encontrado no servidor.';
        } else if (error.message.includes('403')) {
          errorMessage = 'Acesso negado ao arquivo.';
        } else if (error.message.includes('n√£o dispon√≠vel')) {
          errorMessage = 'Fun√ß√£o de processamento n√£o dispon√≠vel. O mapa principal pode n√£o estar carregado.';
        }

        alert(errorMessage);
        updateStatus('Erro ao carregar arquivo');
      } finally {
        showLocalLoading(false);
      }
    }

    // ========= FUN√á√ïES AUXILIARES INDEPENDENTES =========
    function updateStatus(message) {
      const statusEl = document.getElementById('statusText');
      if (statusEl) {
        // Limita o tamanho da mensagem
        const maxLength = 40;
        const shortMessage = message.length > maxLength
          ? message.substring(0, maxLength - 1) + '‚Ä¶'
          : message;

        statusEl.textContent = shortMessage;
        statusEl.title = message; // Tooltip com mensagem completa
      }
    }

    function showLocalLoading(show, message = "Processando...") {
      const loadingEl = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');

      if (loadingEl) {
        loadingEl.classList.toggle('show', show);
      }
      if (message && loadingText) {
        loadingText.textContent = message;
      }
    }

    function updateSystemIndicator() {
      const indicator = document.getElementById('systemIndicator');
      const subtitle = document.getElementById('systemSubtitle');

      if (indicator) {
        indicator.className = 'system-indicator';
        if (currentMode === SYSTEM_MODE.ONLINE) {
          indicator.classList.add('mode-online');
          indicator.textContent = 'ONLINE';
          if (subtitle) subtitle.textContent = 'Sistema Conectado';
        } else if (currentMode === SYSTEM_MODE.MIXED) {
          indicator.classList.add('mode-mixed');
          indicator.textContent = 'MISTO';
          if (subtitle) subtitle.textContent = 'Modo Limitado';
        } else {
          indicator.classList.add('mode-offline');
          indicator.textContent = 'OFFLINE';
          if (subtitle) subtitle.textContent = 'Modo Offline';
        }
      }
    }

    function updateFileMeta() {
      const fileMeta = document.getElementById('currentFile');
      if (fileMeta) {
        if (currentMode === SYSTEM_MODE.ONLINE) {
          fileMeta.textContent = 'Conectado ao servidor';
        } else if (currentMode === SYSTEM_MODE.MIXED) {
          fileMeta.textContent = 'Conex√£o limitada - Modo demonstra√ß√£o';
        } else {
          fileMeta.textContent = 'Modo offline - Dados locais';
        }
      }
    }

    // ========= DETEC√á√ÉO DE MODO DO SISTEMA =========
    async function detectSystemMode() {
      try {
        console.log('üîç Verificando status da API...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const response = await fetch('api/cities.php?action=list', {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          },
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const contentType = response.headers.get('content-type');
        const text = await response.text();

        // Verifica se √© JSON v√°lido
        if (contentType && contentType.includes('application/json')) {
          try {
            const data = JSON.parse(text);
            if (data.ok && Array.isArray(data.data)) {
              console.log('‚úÖ Sistema ONLINE - API funcionando');
              return SYSTEM_MODE.ONLINE;
            } else {
              console.warn('‚ö†Ô∏è API retornou estrutura inv√°lida');
              return SYSTEM_MODE.MIXED;
            }
          } catch (e) {
            console.warn('‚ùå API retornou JSON inv√°lido:', e.message);
            return SYSTEM_MODE.MIXED;
          }
        }

        // Verifica se retornou HTML (erro do servidor)
        if (text.trim().startsWith('<!DOCTYPE') || text.trim().startsWith('<html')) {
          console.warn('‚ö†Ô∏è Sistema MISTO - API retornando HTML');
          return SYSTEM_MODE.MIXED;
        }

        console.warn('‚ö†Ô∏è Sistema OFFLINE - Resposta inesperada');
        return SYSTEM_MODE.OFFLINE;

      } catch (error) {
        if (error.name === 'AbortError') {
          console.warn('üîå Sistema OFFLINE - Timeout na conex√£o');
        } else {
          console.warn('üîå Sistema OFFLINE - Erro de conex√£o:', error.message);
        }
        return SYSTEM_MODE.OFFLINE;
      }
    }

    async function smartApiCall() {
      try {
        console.log('üîÑ Tentando API real...');
        const cities = await apiListCities();
        if (cities && Array.isArray(cities) && cities.length > 0) {
          console.log(`‚úÖ API retornou ${cities.length} cidades`);
          return cities;
        } else {
          console.warn('‚ö†Ô∏è API retornou array vazio ou inv√°lido');
        }
      } catch (error) {
        console.warn('‚ùå API falhou:', error.message);
      }

      // Fallback para dados locais
      console.log('üîÑ Usando dados de demonstra√ß√£o');
      return FALLBACK_CITIES;
    }

    // ========= RENDERIZADOR DE CIDADES =========
    async function renderCityPicker(filter = '') {
      const list = document.getElementById('cityPickerList');
      const searchTerm = (filter || '').trim().toLowerCase();

      if (!list) {
        console.error('‚ùå Elemento cityPickerList n√£o encontrado');
        return;
      }

      try {
        // Mostra loading
        list.innerHTML = `
          <div class="empty">
            <div class="empty-ico"><div class="system-loading"></div></div>
            <p>Carregando cidades...</p>
            <small>Modo: ${currentMode.toUpperCase()}</small>
          </div>
        `;

        // Busca cidades (com fallback autom√°tico)
        const items = await smartApiCall();

        console.log(`üìä ${items.length} cidades carregadas (Modo: ${currentMode})`);

        // Filtra e ordena
        const filteredItems = items.filter(city =>
          !searchTerm ||
          city.name.toLowerCase().includes(searchTerm) ||
          (city.prefix || '').toLowerCase().includes(searchTerm) ||
          (city.file?.name || '').toLowerCase().includes(searchTerm)
        ).sort((a, b) => a.name.localeCompare(b.name));

        // Renderiza resultados
        if (filteredItems.length === 0) {
          list.innerHTML = `
            <div class="empty">
              <div class="empty-ico">üîç</div>
              <p>Nenhuma cidade encontrada</p>
              ${searchTerm ? '<small>Tente outro termo de busca</small>' : ''}
              <small>Modo: ${currentMode.toUpperCase()}</small>
            </div>
          `;
          return;
        }

        list.innerHTML = filteredItems.map(city => `
          <div class="city-item" role="listitem">
            <div class="city-info">
              <div class="city-name">
                ${city.name} ${city.isDefault ? '<span title="Cidade padr√£o" style="margin-left: 4px;">‚≠ê</span>' : ''}
                ${currentMode !== SYSTEM_MODE.ONLINE ? '<span title="Modo demonstra√ß√£o" style="color: orange; margin-left: 4px;">‚ö°</span>' : ''}
              </div>
              <small class="muted">
                Prefixo: <b>${city.prefix || 'N/A'}</b> ‚Ä¢ 
                ${city.file?.name || 'sem arquivo'}
                ${currentMode !== SYSTEM_MODE.ONLINE ? ' ‚Ä¢ <em style="color: #6c757d;">Demonstra√ß√£o</em>' : ''}
              </small>
            </div>
            <button class="btn ${currentMode !== SYSTEM_MODE.ONLINE ? 'secondary' : 'primary'}" 
                    data-id="${city.id}" 
                    data-name="${city.name}"
                    title="${currentMode === SYSTEM_MODE.ONLINE ? 'Carregar cidade no mapa' : 'Visualiza√ß√£o demonstrativa'}">
              ${currentMode === SYSTEM_MODE.ONLINE ? 'Carregar' : 'Demo'}
            </button>
          </div>
        `).join('');

        // Event listeners para os bot√µes
        list.querySelectorAll('button[data-id]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const cityId = btn.dataset.id;
            const cityName = btn.dataset.name;

            // Fecha sidebar no mobile ao selecionar
            if (window.innerWidth < 1024) {
              document.getElementById('kmzSidebar')?.classList.remove('open');
              document.body.classList.remove('sidebar-open');
            }

            try {
              btn.textContent = 'Carregando...';
              btn.disabled = true;

              await loadCityOnMap(cityId);
            } catch (error) {
              console.error('Erro ao carregar cidade:', error);
              if (currentMode !== SYSTEM_MODE.ONLINE) {
                showDemoAlert(cityName);
              } else {
                showErrorAlert(cityName, error.message);
              }
            } finally {
              btn.textContent = currentMode === SYSTEM_MODE.ONLINE ? 'Carregar' : 'Demo';
              btn.disabled = false;
            }
          });
        });

      } catch (error) {
        console.error('Erro cr√≠tico no renderizador:', error);
        list.innerHTML = `
          <div class="empty">
            <div class="empty-ico">‚ö†Ô∏è</div>
            <p>Erro ao carregar cidades</p>
            <small>${error.message}</small>
            <small><button onclick="location.reload()" class="btn link" style="margin-top: 8px;">Recarregar p√°gina</button></small>
          </div>
        `;
      }
    }

    // ========= FUN√á√ïES DE ALERTA =========
    function showDemoAlert(cityName) {
      alert(`üèôÔ∏è ${cityName}\n\nModo Demonstra√ß√£o\n\nEsta √© uma visualiza√ß√£o demonstrativa. Em modo online, o mapa completo seria carregado.`);
    }

    function showErrorAlert(cityName, error) {
      alert(`‚ùå Erro ao carregar ${cityName}\n\n${error}\n\nVerifique se o servidor est√° funcionando corretamente.`);
    }

    // ========= INICIALIZA√á√ÉO INDEPENDENTE =========
    async function initializeSystem() {
      if (systemInitialized) return;

      console.log('üöÄ Iniciando Mapa Lino - Sistema Independente');
      systemInitialized = true;

      // Atualiza UI inicial
      updateStatus('Detectando ambiente...');
      updateSystemIndicator();

      try {
        // Detecta modo do sistema
        currentMode = await detectSystemMode();
        updateSystemIndicator();
        updateFileMeta();

        // Renderiza cidades
        await renderCityPicker();

        // Configura busca em tempo real
        const searchInput = document.getElementById('cityPickerSearch');
        if (searchInput) {
          let searchTimeout;
          searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => renderCityPicker(e.target.value), 300);
          });
        }

        // Atualiza status final
        const statusMessages = {
          [SYSTEM_MODE.ONLINE]: 'Sistema conectado e funcionando',
          [SYSTEM_MODE.MIXED]: 'Sistema em modo limitado',
          [SYSTEM_MODE.OFFLINE]: 'Sistema offline - Dados locais'
        };

        updateStatus(statusMessages[currentMode]);

        // Tenta carregar cidade padr√£o se online
        if (currentMode === SYSTEM_MODE.ONLINE) {
          setTimeout(async () => {
            try {
              const cities = await smartApiCall();
              const defaultCity = cities.find(c => c.isDefault);
              if (defaultCity) {
                console.log('üìç Tentando carregar cidade padr√£o:', defaultCity.name);
                await loadCityOnMap(defaultCity.id);
              }
            } catch (error) {
              console.log('Cidade padr√£o n√£o carregada:', error.message);
            }
          }, 2000);
        }
      } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        updateStatus('Erro ao inicializar sistema');
      }
    }

    // ========= INICIALIZA√á√ÉO IMEDIATA =========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üìÑ DOM carregado - Iniciando sistema independente...');

      // Inicia imediatamente sem esperar script.js
      initializeSystem();

      // Tenta integrar com script.js quando dispon√≠vel
      const checkScriptLoaded = setInterval(() => {
        if (typeof window.setStatus === 'function') {
          clearInterval(checkScriptLoaded);
          console.log('‚úÖ Script.js carregado - Integra√ß√£o estabelecida');
          // Agora podemos usar fun√ß√µes do script.js se necess√°rio
        }
      }, 1000);

      // Timeout para parar de verificar
      setTimeout(() => {
        clearInterval(checkScriptLoaded);
      }, 10000);
    });

    // Exporta fun√ß√µes para uso global
    window.apiListCities = apiListCities;
    window.loadCityOnMap = loadCityOnMap;
    window.initializeCitySystem = initializeSystem;

    console.log('üîß Sistema de cidades carregado - Funcionamento independente');

  </script>

  <!-- Script para carregar a mensagem da home -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const panel = document.getElementById('homeMessagePanel');
      const content = document.getElementById('homeMessageContent');
      const closeBtn = document.getElementById('closeHomeMessage');

      if (!panel || !content || !closeBtn) return;

      try {
        const response = await fetch('api/message.php', { cache: 'no-store' });
        if (!response.ok) return;

        const result = await response.json();
        const messageText = result?.data?.text?.trim();

        if (messageText) {
          content.innerHTML = messageText.replace(/\n/g, '<br>');
          panel.style.display = 'block';
        }
      } catch (e) {
        console.error('Erro ao carregar mensagem da home:', e);
      }

      closeBtn.addEventListener('click', () => {
        panel.style.display = 'none';
      });
    });
  </script>

  <!-- Adicionado: Script para carregar a logo din√¢mica -->
  <script>
    (function () {
      const DEFAULT_LOGO = 'assets/img/image.png';
      const LATEST_LOGO_URL = 'api/latest_logo.php';

      // Fun√ß√£o para aplicar a logo nos elementos da p√°gina
      function applyLogo(src) {
        // Adiciona um cache-bust para garantir que a imagem seja recarregada
        const finalSrc = src + '?' + Date.now();
        const brandLogo = document.getElementById('brandLogo');
        const brandLogoTop = document.getElementById('brandLogoTop');
        const loadingLogo = document.getElementById('loadingLogo');
        // Favicon principal da p√°gina
        const favicon = document.querySelector('link[rel="icon"]');

        if (brandLogo) brandLogo.src = finalSrc;
        if (brandLogoTop) brandLogoTop.src = finalSrc;
        if (loadingLogo) loadingLogo.src = finalSrc;
        if (favicon) favicon.href = finalSrc;
      }

      // Fun√ß√£o para buscar a logo mais recente
      async function loadLatestLogo() {
        try {
          const response = await fetch(LATEST_LOGO_URL, { cache: 'no-store' });
          const data = await response.json();

          if (data.ok && data.logoUrl) {
            applyLogo(data.logoUrl);
          } else {
            // Se a API falhar ou n√£o retornar URL, usa a padr√£o
            applyLogo(DEFAULT_LOGO);
          }
        } catch (error) {
          // Se houver erro de rede, usa a logo padr√£o
          console.warn('N√£o foi poss√≠vel carregar a logo mais recente. Usando a padr√£o.', error);
          applyLogo(DEFAULT_LOGO);
        }
      }

      // Executa a verifica√ß√£o assim que o DOM estiver pronto
      document.addEventListener('DOMContentLoaded', loadLatestLogo);
    })();
  </script>

</body>

</html>