<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest?v=1">
  <link rel="icon" id="favicon" href="assets/icons/icon-192.png" type="image/png">
  <!-- iOS / iPadOS -->
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GeoViewer">
  <!-- Android/Chrome (opcional, ajuda no meta-theme) -->
  <meta name="theme-color" content="#0d6efd">
  <title>Mapa Lino ‚Äî Admin</title>
  <!-- Leaflet (CSS) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <!-- Seu CSS -->
  <link rel="stylesheet" href="assets/styles.css?v=5" />
  <!-- Favicon com id para ser atualizado junto da logo -->
  <link id="favicon" rel="icon" type="image/png" href="assets/img/image.png" />
  <style>
    .city-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      background: var(--panel-2);
      transition: all 0.2s ease;
    }

    .city-item:hover {
      border-color: var(--primary);
      transform: translateY(-1px);
    }

    .city-info {
      min-width: 0;
      flex: 1;
    }

    .city-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
    }

    .system-loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>

  <!-- ========== SIDEBAR ESQUERDA (CONFIG / LISTAS) ========== -->
  <aside class="sidebar" aria-label="Barra lateral">

    <!-- Cabe√ßalho -->
    <div class="sidebar-header">
      <div class="brand">
        <!-- LOGO -->
        <div class="brand-logo-wrap">
          <img id="brandLogo" src="assets/img/image.png" alt="Logo" title="Clique para trocar (Shift+Clique restaura)"
            tabindex="0" />
          <!-- mini-fab (USADO NO MOBILE) -->
          <button id="changeLogoBtn" class="mini-fab" type="button" aria-label="Trocar logo"></button>
        </div>

        <!-- T√çTULOS + BOT√ÉO INLINE (DESKTOP) -->
        <div class="brand-text">
          <div class="brand-titles">
            <h1 class="app-title">Mapa Lino</h1>
            <p class="app-subtitle">Painel de Controle</p>
          </div>

          <!-- bot√£o inline; clique faz o mesmo que o mini-fab -->
          <button id="changeLogoBtnInline" class="brand-inline-btn" type="button" aria-label="Trocar logo">
            Trocar logo
          </button>
        </div>
      </div>

      <!-- input escondido para upload -->
      <input type="file" id="logoFileInput" accept="image/*" hidden />

      <!-- O X s√≥ aparece no mobile (CSS j√° cobre isso) -->
      <button class="ghost-btn" id="closeSidebar" title="Fechar painel" aria-label="Fechar painel">‚úï</button>
    </div>

    <!-- Se√ß√µes -->
    <nav class="sidebar-sections" aria-label="Se√ß√µes">

      <!-- ========== UPLOAD DE KMZ AVULSO ========== -->
      <section class="panel-section" aria-labelledby="sec-kmz-upload">
        <h2 id="sec-kmz-upload">üì§ Adicionar Arquivo KMZ</h2>
        <form id="sidebarKmzUploadForm" class="form" autocomplete="off" novalidate>
          <p class="muted" style="margin: -0.5rem 0 1rem; text-align: center;">
            Arraste e solte um arquivo ou clique na √°rea abaixo.
          </p>
          <div id="kmzDropZone" class="drop-zone">
            <input type="file" id="sidebarKmzFileInput" accept=".kmz" required hidden />
            <label for="sidebarKmzFileInput" class="drop-zone-label">
              <span class="drop-zone-icon">üì§</span>
              <span class="drop-zone-text">Clique para selecionar</span>
              <small class="drop-zone-info">ou arraste e solte o arquivo</small>
            </label>

          </div>
          <div class="row" style="margin-top: .75rem;">
            <input type="text" id="sidebarKmzFolderName" class="input-flat" placeholder="Nome da pasta (opcional)"
              style="width:100%;" />
          </div>
          <div class="row" style="margin-top:.75rem">
            <button type="submit" class="btn primary" style="width: 100%; justify-content: center;">Enviar
              Arquivo</button>
          </div>
          <div id="sidebarKmzUploadStatus" class="form-status" style="margin-top: 0.75rem;"></div>
        </form>
      </section>

      <!-- ========== CIDADES ========== -->
      <section class="panel-section" aria-labelledby="sec-cities-sidebar">
        <h2 id="sec-cities-sidebar">üåÜ Cidades</h2>

        <div class="row gap">
          <div class="search small" style="flex:1">
            <input id="cityPickerSearch" type="search" placeholder="Buscar cidade/bairro‚Ä¶"
              aria-label="Buscar cidade ou bairro" />
          </div>
        </div>

        <div id="cityPickerList" class="list-card" role="list" aria-label="Cidades dispon√≠veis"
          style="margin-top:8px; max-height: 280px; overflow:auto;">
          <div class="empty">
            <div class="empty-ico">‚è≥</div>
            <p>Inicializando sistema...</p>
          </div>
        </div>
      </section>

      <!-- ========== MENSAGEM DA HOME ========== -->
      <div class="home-msg-card">
        <h3 class="home-msg-title">Mensagem da p√°gina inicial</h3>

        <label class="home-msg-label" for="homeMsgText">Conte√∫do</label>
        <textarea id="homeMsgText" class="home-msg-textarea"
          placeholder="Escreva a mensagem que aparecer√° na home‚Ä¶"></textarea>

        <div class="row gap" style="margin-top:.5rem">
          <button id="btnHomeMsgSave" class="home-msg-save">Salvar mensagem</button>
          <span id="homeMsgStatus" class="muted"></span>
        </div>

        <details class="home-msg-details">
          <summary>Pr√©-visualizar</summary>
          <div class="home-msg-preview-box" id="homeMsgPreview">‚Äî</div>
        </details>
      </div>

      <!-- ========== CAMADAS / ALIMENTADORES (LINHAS) ========== -->
      <section class="panel-section" aria-labelledby="sec-layers">
        <h2 id="sec-layers">üóÇÔ∏è Camadas / Alimentadores</h2>

        <div class="row gap">
          <button id="hideAllLayers" class="btn">Ocultar todas</button>
          <button id="showAllLayers" class="btn">Exibir todas</button>
        </div>

        <div id="layersList" class="layers-list" role="group" aria-label="Lista de camadas / alimentadores">
          <div class="empty">
            <div class="empty-ico">üóÇÔ∏è</div>
            <p>Nenhuma camada carregada</p>
          </div>
        </div>
      </section>

      <!-- ========== CAMADAS / GRUPOS DE POSTOS ========== -->
      <section class="panel-section" aria-labelledby="sec-posts">
        <h2 id="sec-posts">üìå Grupos de Postos</h2>

        <div class="row gap">
          <button id="hideAllPosts" class="btn">Ocultar todas</button>
          <button id="showAllPosts" class="btn">Exibir todas</button>
        </div>

        <div id="postsLayersList" class="layers-list" role="group" aria-label="Lista de grupos de postos">
          <div class="empty">
            <div class="empty-ico">üìç</div>
            <p>Nenhum posto carregado</p>
          </div>
        </div>
      </section>

      <!-- ========== ESTAT√çSTICAS ========== -->
      <section class="panel-section" aria-labelledby="sec-stats">
        <h2 id="sec-stats">üìä Estat√≠sticas</h2>
        <ul class="stats-grid" role="list">
          <li class="stat">
            <div class="stat-ico">üìç</div>
            <div class="stat-val" id="markerCount">0</div>
            <div class="stat-lbl">Marcadores</div>
          </li>
          <li class="stat">
            <div class="stat-ico">üìè</div>
            <div class="stat-val" id="lineCount">0</div>
            <div class="stat-lbl">Linhas</div>
          </li>
          <li class="stat">
            <div class="stat-ico">‚¨°</div>
            <div class="stat-val" id="polygonCount">0</div>
            <div class="stat-lbl">Pol√≠gonos</div>
          </li>
        </ul>
      </section>
    </nav>
  </aside>

  <!-- ========== TOPO (BUSCA + ACESSIBILIDADE) ========== -->
  <header id="topbar" class="topbar" role="banner">
    <div class="top-left">
      <button id="openSidebar" class="icon-btn" aria-label="Abrir painel">‚ò∞</button>

      <a class="top-brand" href="#" aria-label="Mapa Lino">
        <img id="brandLogoTop" src="assets/img/image.png" alt="Logo Mapa Lino" />
      </a>
    </div>

    <div class="top-center" role="search">
      <form id="searchForm" class="search" autocomplete="off">
        <input id="searchInput" type="search" placeholder="Buscar local, bairro, cidade..."
          aria-label="Buscar localiza√ß√£o" />
        <button id="searchBtn" type="submit" class="icon-btn" aria-label="Buscar">üîé</button>
      </form>
      <div id="searchResults" class="search-results" role="listbox" aria-label="Resultados de busca"></div>
    </div>

    <div class="top-right" aria-label="Acessibilidade" role="group">
      <button id="openCities" class="icon-btn" title="Cidades & Arquivos"
        aria-label="Gerenciar cidades e arquivos">üèôÔ∏è</button>
      <button id="themeToggle" class="icon-btn" title="Modo escuro" aria-pressed="false"
        aria-label="Alternar tema">üåô</button>
    </div>
  </header>

  <!-- ========== CONTE√öDO PRINCIPAL / MAPA ========== -->
  <main id="content" class="content" role="main">
    <div id="map" class="map" aria-label="Mapa"></div>

    <!-- Controles flutuantes do mapa -->
    <div class="map-fab-group" aria-label="Controles do mapa" role="group">
      <button id="toggleSatellite" class="fab" title="Vista sat√©lite" aria-pressed="false">üõ∞Ô∏è</button>
      <button id="toggleTerrain" class="fab" title="Vista terreno" aria-pressed="false">üèîÔ∏è</button>
      <button id="zoomIn" class="fab" title="Aproximar">Ôºã</button>
      <button id="zoomOut" class="fab" title="Afastar">Ôºç</button>
      <button id="locateMe" class="fab" title="Minha localiza√ß√£o">üìç</button>
    </div>

    <!-- Painel de fotos/detalhes -->
    <aside id="photoPanel" class="photo-panel" aria-label="Detalhes do local" aria-hidden="true">
      <header class="photo-header">
        <h3>üì∏ Detalhes do local</h3>
        <button id="closePhoto" class="icon-btn" aria-label="Fechar painel">‚úï</button>
      </header>
      <div id="photoContent" class="photo-content">
        <div class="photo-empty">
          <div class="empty-ico">üñºÔ∏è</div>
          <p>Clique em um marcador para ver detalhes</p>
        </div>
      </div>
    </aside>
  </main>

  <!-- ========== STATUS BAR ========== -->
  <footer id="statusBar" class="statusbar" role="contentinfo" aria-live="polite">
    <div class="status-left">
      <span class="status-dot" aria-hidden="true"></span>
      <span id="statusText">Sistema pronto</span>
    </div>

    <div class="developer-credit">
      <small>
        <strong>Desenvolvido por</strong>
        Leandro Lino ¬© 2025
      </small>
    </div>

    <div id="filesUpdatedAt" class="status-updates">
      √öltimas atualiza√ß√µes: ‚Äî
    </div>

    <div id="coordinates" class="status-right" aria-label="Coordenadas do cursor">
      Lat: 0.000000, Lon: 0.000000
    </div>
  </footer>

  <!-- ========== LOADING OVERLAY ========== -->
  <div id="loadingOverlay" class="loading" aria-hidden="true" aria-live="polite">
    <div class="loading-box" role="alert">
      <img id="loadingLogo" class="loading-logo" alt="" />
      <p id="loadingText">Processando arquivo‚Ä¶</p>
    </div>
  </div>

  <!-- ========== MODAL: CIDADES / ARQUIVOS ========== -->
  <dialog id="citiesDialog" class="modal modal-lg" aria-labelledby="citiesTitle">
    <header class="modal-header">
      <h3 id="citiesTitle">üèôÔ∏è Cidades &amp; Arquivos</h3>
      <button id="closeCities" class="icon-btn" aria-label="Fechar">‚úï</button>
    </header>

    <div class="modal-body grid-2">
      <!-- Coluna esquerda: formul√°rio -->
      <form id="cityForm" class="form card" autocomplete="off">
        <h4>Cadastro / Edi√ß√£o</h4>

        <label class="field">
          <span>Nome da cidade</span>
          <input id="cityName" type="text" placeholder="Ex.: Araraquara" required />
        </label>

        <label class="field">
          <span>Prefixo (opcional)</span>
          <input id="cityPrefix" type="text" maxlength="6" placeholder="Ex.: ARA" />
          <small class="muted">Se vazio, geramos automaticamente pelo nome.</small>
        </label>

        <label class="field">
          <span>Arquivo KML/KMZ</span>
          <input id="cityFile" type="file" accept=".kml,.kmz" />
          <small class="muted">Envie para adicionar ou substituir o arquivo da cidade.</small>
        </label>

        <div class="row gap">
          <button id="btnCityNew" type="button" class="btn">Novo</button>
          <button id="btnCitySave" type="submit" class="btn primary">Salvar</button>
          <button id="btnCityDelete" type="button" class="btn danger">Excluir</button>
        </div>

        <input type="hidden" id="cityId" />
      </form>

      <!-- NOVO: Formul√°rio de Upload de KMZ Avulso -->
      <form id="kmzUploadForm" class="form card" autocomplete="off" style="margin-top: 1rem;">
        <h4>Upload de Arquivo KMZ Avulso</h4>
        <p class="muted" style="margin-bottom: 1rem;">
          Use este formul√°rio para enviar um arquivo KMZ que n√£o est√° associado a uma cidade espec√≠fica.
          O arquivo ser√° salvo em uma pasta √∫nica dentro de <code>/uploads/cities/</code>.
        </p>

        <label class="field">
          <span>Arquivo KMZ</span>
          <input id="kmzFileInput" type="file" accept=".kmz" required />
        </label>

        <label class="field">
          <span>Nome da Pasta (Opcional)</span>
          <input id="kmzFolderNameInput" type="text" placeholder="Ex.: MinhaNovaCidade" />
          <small class="muted">Se deixar em branco, ser√° gerado um ID autom√°tico.</small>
        </label>

        <div class="row gap">
          <button type="submit" class="btn primary">Enviar Arquivo</button>
        </div>
        <div id="kmzUploadStatus" class="form-status" style="margin-top: 0.5rem;"></div>
      </form>

      <!-- Coluna direita: lista -->
      <section class="card">
        <div class="row spread center">
          <h4>Lista de cidades</h4>
          <div class="search small">
            <input id="citySearch" type="search" placeholder="Buscar cidade‚Ä¶" aria-label="Buscar cidade">
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="cityTable" aria-label="Cidades cadastradas">
            <thead>
              <tr>
                <th style="width:40%">Cidade</th>
                <th style="width:20%">Prefixo</th>
                <th style="width:25%">Arquivo</th>
                <th style="width:15%" class="right">A√ß√µes</th>
                <th style="width:15%" class="right">Excluir</th>
              </tr>
            </thead>
            <tbody id="cityList">
              <!-- linhas via JS -->
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <footer class="modal-footer">
      <button id="okCities" class="btn">Fechar</button>
    </footer>
  </dialog>

  <!-- Template para linhas da tabela de cidades -->
  <template id="cityRowTpl">
    <tr>
      <td data-col="name">-</td>
      <td data-col="prefix">-</td>
      <td data-col="file">-</td>
      <td class="right">
        <div class="row-actions">
          <button class="icon-link" data-act="load" title="Carregar no mapa">üì•</button>
          <button class="icon-link" data-act="edit" title="Editar">‚úèÔ∏è</button>
        </div>
      </td>
      <td class="right">
        <div class="row-actions">
          <button class="icon-link" data-act="delete" title="Excluir">‚ùå</button>
        </div>
      </td>
    </tr>
  </template>

  <!-- Confirma√ß√£o de exclus√£o -->
  <dialog id="confirmDeleteCityDialog" class="modal" aria-labelledby="confirmDelTitle">
    <header class="modal-header">
      <h3 id="confirmDelTitle">Excluir cidade</h3>
    </header>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir <strong id="confirmDelCityName">esta cidade</strong> e seu arquivo?</p>
    </div>
    <footer class="modal-footer">
      <button id="confirmDelCancel" class="btn">Cancelar</button>
      <button id="confirmDelOk" class="btn danger">Excluir</button>
    </footer>
  </dialog>

  <!-- ========== MODAL: AJUDA / ATALHOS ========== -->
  <dialog id="shortcutsDialog" class="modal" aria-labelledby="shortcutsTitle">
    <header class="modal-header">
      <h3 id="shortcutsTitle">Atalhos r√°pidos</h3>
      <button id="closeShortcuts" class="icon-btn" aria-label="Fechar">‚úï</button>
    </header>
    <div class="modal-body">
      <ul class="kbd-list">
        <li><kbd>/</kbd> Focar busca</li>
        <li><kbd>G</kbd> Ir para minha localiza√ß√£o</li>
        <li><kbd>+</kbd>/<kbd>-</kbd> Zoom</li>
        <li><kbd>L</kbd> Linhas de refer√™ncia</li>
        <li><kbd>T</kbd> Alternar tema escuro</li>
      </ul>
    </div>
    <footer class="modal-footer">
      <button id="okShortcuts" class="btn primary">Entendi</button>
    </footer>
  </dialog>

  <!-- ====== CONFIG do editor da Mensagem da Home ====== -->
  <script>
    const ADMIN_MESSAGE_TOKEN = 'troque-este-token-seguro';

    async function adminLoadHomeMessage() {
      try {
        const r = await fetch('api/message.php', { cache: 'no-store' });
        const j = await r.json();
        const txt = (j?.data?.text || '');
        const ta = document.getElementById('homeMsgText');
        const prev = document.getElementById('homeMsgPreview');
        if (ta) ta.value = txt;
        if (prev) prev.innerHTML = txt.replace(/\n/g, '<br>');
      } catch (e) { }
    }

    async function adminSaveHomeMessage() {
      const ta = document.getElementById('homeMsgText');
      const st = document.getElementById('homeMsgStatus');
      const prev = document.getElementById('homeMsgPreview');
      const text = (ta?.value || '').trim();

      try {
        if (st) st.textContent = 'Salvando‚Ä¶';
        const r = await fetch('api/message.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': ADMIN_MESSAGE_TOKEN
          },
          body: JSON.stringify({ text })
        });
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || 'Falha ao salvar');
        if (st) st.textContent = '‚úÖ Mensagem salva';
        if (prev) prev.innerHTML = text.replace(/\n/g, '<br>');
      } catch (err) {
        if (st) st.textContent = '‚ùå ' + (err.message || 'Erro');
      } finally {
        setTimeout(() => { if (st) st.textContent = ''; }, 2500);
      }
    }

    document.getElementById('btnHomeMsgSave')?.addEventListener('click', adminSaveHomeMessage);
    document.getElementById('homeMsgText')?.addEventListener('input', (e) => {
      const prev = document.getElementById('homeMsgPreview');
      if (prev) prev.innerHTML = (e.target.value || '').replace(/\n/g, '<br>');
    });
  </script>

  <!-- ====== LOGO: upload no SERVIDOR (PHP) + restaurar padr√£o ====== -->
  <script>
    (async function () {
      const DEFAULT_LOGO = 'assets/img/image.png';
      const UPLOAD_URL = 'api/upload_logo.php';
      const LATEST_LOGO_URL = 'api/latest_logo.php';

      const img = document.getElementById('brandLogo');
      const imgTop = document.getElementById('brandLogoTop');
      const loadingLogo = document.getElementById('loadingLogo');
      const favicon = document.getElementById('favicon');
      const fileInput = document.getElementById('logoFileInput');
      const btnFab = document.getElementById('changeLogoBtn');
      const btnInline = document.getElementById('changeLogoBtnInline');

      function applyLogo(src) {
        // Adiciona um cache-bust para garantir que a imagem seja recarregada
        const finalSrc = src + '?' + Date.now();
        if (img) img.src = finalSrc;
        if (imgTop) imgTop.src = finalSrc;
        if (loadingLogo) loadingLogo.src = finalSrc;
        if (favicon) favicon.href = finalSrc;
      }

      async function loadLatestLogo() {
        try {
          const res = await fetch(LATEST_LOGO_URL, { cache: 'no-store' });
          const data = await res.json();
          if (data.ok && data.logoUrl) {
            applyLogo(data.logoUrl);
          } else {
            applyLogo(DEFAULT_LOGO);
          }
        } catch {
          applyLogo(DEFAULT_LOGO);
        }
      }

      async function uploadLogo(file) {
        const fd = new FormData();
        fd.append('logo', file);

        try {
          const resp = await fetch(UPLOAD_URL, { method: 'POST', body: fd });
          const j = await resp.json();
          if (!j.ok || !j.logoUrl) throw new Error(j.error || 'Falha no upload');

          // Usa a URL retornada diretamente pelo servidor
          applyLogo(j.logoUrl);
          alert('‚úÖ Logo atualizada com sucesso!');
        } catch (err) {
          alert('‚ùå Erro ao enviar: ' + err.message);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadLatestLogo();
        adminLoadHomeMessage();
        if (typeof renderRecentUploadsPanel === 'function') {
          renderRecentUploadsPanel();
        }
      });

      // Clique na logo (Shift = restaurar p/ padr√£o local)
      img?.addEventListener('click', async (ev) => {
        if (ev.shiftKey) {
          if (confirm('Restaurar visualmente para a logo padr√£o (sem apagar do servidor)?')) {
            applyLogo(DEFAULT_LOGO);
          }
          return;
        }
        fileInput?.click();
      });

      // Acessibilidade: Enter/Espa√ßo abre upload
      img?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          fileInput?.click();
        }
      });

      // Bot√µes que chamam o mesmo input
      btnFab?.addEventListener('click', () => fileInput?.click());
      btnInline?.addEventListener('click', () => fileInput?.click());

      // Upload -> PHP
      fileInput?.addEventListener('change', (ev) => {
        const file = ev.target.files?.[0];
        if (!file) return;

        if (!file.type.startsWith('image/')) {
          alert('Selecione uma imagem (PNG, JPG, WEBP, GIF, SVG).');
          ev.target.value = '';
          return;
        }
        if (file.size > 2 * 1024 * 1024) {
          alert('Imagem muito grande (m√°x. 2 MB).');
          ev.target.value = '';
          return;
        }

        uploadLogo(file);
        ev.target.value = '';
      });
    })();
  </script>

  <!-- ====== UPLOAD DE KMZ AVULSO ====== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const kmzUploadForm = document.getElementById('kmzUploadForm');
      if (!kmzUploadForm) return;

      const kmzFileInput = document.getElementById('kmzFileInput');
      const kmzUploadStatus = document.getElementById('kmzUploadStatus');

      kmzUploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!kmzFileInput.files || kmzFileInput.files.length === 0) {
          kmzUploadStatus.textContent = 'Por favor, selecione um arquivo.';
          kmzUploadStatus.className = 'form-status error';
          return;
        }

        const file = kmzFileInput.files[0];
        const folderNameVal = document.getElementById('kmzFolderNameInput')?.value || '';

        const formData = new FormData();
        formData.append('action', 'upload_standalone_kmz');
        formData.append('kmz_file', file);
        formData.append('folder_name', folderNameVal);

        kmzUploadStatus.textContent = 'Enviando arquivo...';
        kmzUploadStatus.className = 'form-status info';

        try {
          const response = await fetch('api/cities.php', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (response.ok && result.ok) {
            kmzUploadStatus.textContent = `‚úÖ Sucesso! Arquivo salvo em: ${result.path}`;
            kmzUploadStatus.className = 'form-status success';
            kmzUploadForm.reset(); // Limpa o campo de arquivo

            // Integra√ß√£o com o painel de uploads recentes
            if (typeof saveRecentUpload === 'function' && typeof renderRecentUploadsPanel === 'function') {
              const uploadInfo = {
                city_name: folderNameVal || 'Arquivo Avulso',
                file_name: file.name,
                file_path: result.path,
                file_size: file.size,
                uploaded_at: Date.now(),
              };
              saveRecentUpload(uploadInfo);
              renderRecentUploadsPanel();
            }
          } else {
            throw new Error(result.error || 'Erro desconhecido no servidor.');
          }
        } catch (error) {
          kmzUploadStatus.textContent = `‚ùå Erro: ${error.message}`;
          kmzUploadStatus.className = 'form-status error';
        }
      });
    });
  </script>

  <!-- ====== UPLOAD DE KMZ NA SIDEBAR ====== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebarKmzUploadForm = document.getElementById('sidebarKmzUploadForm');
      if (!sidebarKmzUploadForm) return;

      const kmzFileInput = document.getElementById('sidebarKmzFileInput');
      const kmzUploadStatus = document.getElementById('sidebarKmzUploadStatus');
      const dropZone = document.getElementById('kmzDropZone');
      const dropZoneText = dropZone.querySelector('.drop-zone-text');
      const dropZoneIcon = dropZone.querySelector('.drop-zone-icon');

      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        }, false);
      });

      // Highlight drop zone when item is dragged over it
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.add('drag-over');
        }, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.classList.remove('drag-over');
        }, false);
      });

      // Handle dropped files
      dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          // Ensure only KMZ files are accepted
          if (files[0].name.toLowerCase().endsWith('.kmz')) {
            kmzFileInput.files = files;
            updateDropZoneWithFile(files[0]);
          } else {
            kmzUploadStatus.textContent = 'Apenas arquivos .kmz s√£o permitidos.';
            kmzUploadStatus.className = 'form-status error';
          }
        }
      });

      // Update drop zone when file is selected via click
      kmzFileInput.addEventListener('change', () => {
        if (kmzFileInput.files.length > 0) {
          updateDropZoneWithFile(kmzFileInput.files[0]);
        }
      });

      function updateDropZoneWithFile(file) {
        if (file) {
          dropZoneText.textContent = file.name;
          dropZoneIcon.textContent = 'üìÑ';
          dropZone.classList.add('has-file');
          kmzUploadStatus.textContent = ''; // Clear previous status
        }
      }

      function resetDropZone() {
        dropZoneText.textContent = 'Clique para selecionar';
        dropZoneIcon.textContent = 'üì§';
        dropZone.classList.remove('has-file');
        sidebarKmzUploadForm.reset();
      }

      sidebarKmzUploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!kmzFileInput.files || kmzFileInput.files.length === 0) {
          kmzUploadStatus.textContent = 'Por favor, selecione um arquivo.';
          kmzUploadStatus.className = 'form-status error';
          return;
        }

        const file = kmzFileInput.files[0];
        const folderNameVal = document.getElementById('sidebarKmzFolderName')?.value || '';

        const formData = new FormData();
        formData.append('action', 'upload_standalone_kmz');
        formData.append('kmz_file', file);
        formData.append('folder_name', folderNameVal);

        kmzUploadStatus.textContent = 'Enviando arquivo...';
        kmzUploadStatus.className = 'form-status info';

        try {
          const response = await fetch('api/cities.php', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (response.ok && result.ok) {
            kmzUploadStatus.textContent = `‚úÖ Sucesso! Salvo em: ${result.path}`;
            kmzUploadStatus.className = 'form-status success';
            setTimeout(resetDropZone, 2000); // Reset after 2 seconds

            if (typeof saveRecentUpload === 'function' && typeof renderRecentUploadsPanel === 'function') {
              const uploadInfo = {
                city_name: folderNameVal || 'Arquivo Avulso',
                file_name: file.name,
                file_path: result.path,
                file_size: file.size,
                uploaded_at: Date.now(),
              };
              await saveRecentUpload(uploadInfo);
              renderRecentUploadsPanel();
            }
          } else {
            throw new Error(result.error || 'Erro desconhecido no servidor.');
          }
        } catch (error) {
          kmzUploadStatus.textContent = `‚ùå Erro: ${error.message}`;
          kmzUploadStatus.className = 'form-status error';
        }
      });
    });
  </script>

  <!-- ========== LIBS & SEU SCRIPT ========== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="assets/script.js?v=7"></script>
  <script src="assets/city-manager.js"></script>

  <script>
    /* ========= SIDEBAR CITY PICKER ========= */
    (function () {
      const API_URL = 'api/cities.php';

      async function apiListCities() {
        try {
          const response = await fetch(`${API_URL}?action=list`, {
            method: 'GET',
            headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          if (data.ok && Array.isArray(data.data)) return data.data;
          throw new Error('Invalid API response');
        } catch (error) {
          console.error('‚ùå Error listing cities:', error);
          throw error;
        }
      }

      async function renderCityPicker(filter = '') {
        const list = document.getElementById('cityPickerList');
        const searchTerm = (filter || '').trim().toLowerCase();

        if (!list) {
          console.error('‚ùå Elemento cityPickerList n√£o encontrado');
          return;
        }

        try {
          list.innerHTML = `
            <div class="empty">
              <div class="empty-ico"><div class="system-loading"></div></div>
              <p>Carregando cidades...</p>
            </div>`;

          const items = await apiListCities();

          const filteredItems = items.filter(city =>
            !searchTerm ||
            city.name.toLowerCase().includes(searchTerm) ||
            (city.prefix || '').toLowerCase().includes(searchTerm) ||
            (city.file?.name || '').toLowerCase().includes(searchTerm)
          ).sort((a, b) => a.name.localeCompare(b.name));

          if (filteredItems.length === 0) {
            list.innerHTML = `
              <div class="empty">
                <div class="empty-ico">üîç</div>
                <p>Nenhuma cidade encontrada</p>
                ${searchTerm ? '<small>Tente outro termo</small>' : ''}
              </div>`;
            return;
          }

          list.innerHTML = filteredItems.map(city => `
            <div class="city-item" role="listitem" id="sidebar-city-item-${city.id}">
              <div class="city-info">
                <div class="city-name-view">
                    <div class="city-name">${city.name}</div>
                    <small class="muted">
                      Prefixo: <b>${city.prefix || 'N/A'}</b> ‚Ä¢ ${city.file?.name || 'sem arquivo'}
                    </small>
                </div>
                <div class="city-name-edit" style="display: none; flex: 1;">
                    <input type="text" class="input-flat" value="${city.name}" style="width: 100%;"/>
                </div>
              </div>
              <div class="city-actions view-mode" style="display: flex; gap: 4px;">
                <button class="btn-action primary" data-action="load" data-id="${city.id}" title="Carregar no mapa">üì•</button>
                <button class="btn-action" data-action="edit" data-id="${city.id}" title="Editar nome">‚úèÔ∏è</button>
                <button class="btn-action danger" data-action="delete" data-id="${city.id}" data-name="${city.name}" title="Excluir cidade">‚úï</button>
              </div>
              <div class="city-actions edit-mode" style="display: none; gap: 4px;">
                <button class="btn-action" data-action="save" data-id="${city.id}" title="Salvar">‚úîÔ∏è</button>
                <button class="btn-action" data-action="cancel" data-id="${city.id}" title="Cancelar">‚úñÔ∏è</button>
              </div>
            </div>
          `).join('');

          // Event Delegation for all actions
          list.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const cityId = target.dataset.id;
            const item = document.getElementById(`sidebar-city-item-${cityId}`);

            if (action === 'load') {
              // Close sidebar on mobile
              if (window.innerWidth < 1024) {
                document.getElementById('kmzSidebar')?.classList.remove('open'); // Try explicit ID if exists
                document.querySelector('.sidebar')?.classList.remove('open'); // Fallback class
                document.body.classList.remove('sidebar-open');
              }

              try {
                target.disabled = true;
                // Assuming loadCityOnMap is available from assets/script.js
                if (typeof loadCityOnMap === 'function') {
                  await loadCityOnMap(cityId);
                } else {
                  alert('Fun√ß√£o loadCityOnMap n√£o encontrada.');
                }
              } catch (e) {
                console.error(e);
                alert('Erro ao carregar cidade: ' + e.message);
              } finally {
                target.disabled = false;
              }

            } else if (action === 'delete') {
              const cityName = target.dataset.name;
              if (!confirm(`Tem certeza que deseja excluir a cidade "${cityName}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
              }
              try {
                target.textContent = '...';
                target.disabled = true;
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('id', cityId);
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (!result.ok) throw new Error(result.error || 'Erro desconhecido');
                item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                item.style.opacity = '0';
                item.style.transform = 'scale(0.95)';
                setTimeout(() => renderCityPicker(document.getElementById('cityPickerSearch').value), 300);
              } catch (error) {
                console.error(`Erro ao excluir cidade:`, error);
                alert(`N√£o foi poss√≠vel excluir a cidade "${cityName}".\n\nMotivo: ${error.message}`);
                target.textContent = '‚úï';
                target.disabled = false;
              }
            } else if (action === 'edit') {
              item.querySelector('.city-name-view').style.display = 'none';
              item.querySelector('.city-actions.view-mode').style.display = 'none';
              item.querySelector('.city-name-edit').style.display = 'block';
              item.querySelector('.city-actions.edit-mode').style.display = 'flex';
              item.querySelector('.city-name-edit input').focus();
            } else if (action === 'cancel') {
              item.querySelector('.city-name-view').style.display = 'block';
              item.querySelector('.city-actions.view-mode').style.display = 'flex';
              item.querySelector('.city-name-edit').style.display = 'none';
              item.querySelector('.city-actions.edit-mode').style.display = 'none';
            } else if (action === 'save') {
              const input = item.querySelector('.city-name-edit input');
              const newName = input.value.trim();
              const originalName = item.querySelector('.city-name').textContent;

              if (!newName || newName === originalName) {
                // If name is empty or unchanged, just cancel editing
                item.querySelector('[data-action="cancel"]').click();
                return;
              }

              try {
                target.textContent = '...';
                target.disabled = true;

                const formData = new FormData();
                formData.append('action', 'rename');
                formData.append('id', cityId);
                formData.append('newName', newName);

                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (!result.ok) throw new Error(result.error || 'Erro desconhecido');

                // Refresh list to show changes
                await renderCityPicker(document.getElementById('cityPickerSearch').value);

              } catch (error) {
                console.error('Erro ao renomear cidade:', error);
                alert(`N√£o foi poss√≠vel renomear a cidade.\n\nMotivo: ${error.message}`);
                target.textContent = '‚úîÔ∏è';
                target.disabled = false;
              }
            }
          });

        } catch (error) {
          console.error('Erro cr√≠tico no renderizador de cidades da sidebar:', error);
          list.innerHTML = `
            <div class="empty">
              <div class="empty-ico">‚ö†Ô∏è</div>
              <p>Erro ao carregar cidades</p>
              <small>${error.message}</small>
              <small><button onclick="window.location.reload()" class="btn link" style="margin-top: 8px;">Recarregar</button></small>
            </div>`;
        }
      }

      // Initial render and search setup
      document.addEventListener('DOMContentLoaded', () => {
        renderCityPicker();

        const searchInput = document.getElementById('cityPickerSearch');
        if (searchInput) {
          let searchTimeout;
          searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => renderCityPicker(e.target.value), 300);
          });
        }
      });

    })();
  </script>
</body>

</html>